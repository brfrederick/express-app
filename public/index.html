<!DOCTYPE html>
<html>
    <head>
        <title>Are your eyes bleeding yet?</title>
        
        <style>
          
            body {
              background-image: linear-gradient(135deg, rgba(0, 0, 0, 0) 84px, #d95b43 84px, #d95b43 100px, #ecd078 100px, #ecd078 106px, #c02942 106px, #c02942 120px, #ecd078 121px, #ecd078 127px, #542437 127px, #542437 142px, #ecd078 142px, #ecd078 148px, #53777a 148px, #53777a 163px, #ecd078 163px, #ecd078 168px, #d95b43 169px), linear-gradient(135deg, #d95b43 15px, #d95b43, #ecd078 15px, #ecd078 21px, #c02942 21px, #c02942 36px, #ecd078 36px, #ecd078 42px, #542437 42px, #542437 57.5px, #ecd078 57px, #ecd078 63px, #53777a 63px, #53777a 78px, #ecd078 78px, #ecd078 84px, rgba(0, 0, 0, 0) 84px, rgba(0, 0, 0, 0) 99px);
              background-size: 120px 120px;

                color:white;
                font-size: 6vmin;
                text-align: center;
                font-family: 'Permanent Marker', cursive;
                text-shadow: -5px 0 black, 0 5px black, 5px 0 black, 0 -5px black;
                margin-top: 4em;
            }

        </style>
        
        <script src="/socket.io/socket.io.js"></script>
        <script>
            
            var socket;
            var canvas;
            var ctx;            
            
            var user = 'user' + (Math.floor((Math.random() * 1000)) + 1);
            var entities = {};
            
            // Draws entities to screen
            function draw(){
                ctx.clearRect(0,0,canvas.width, canvas.height);
                
                var keys = Object.keys(entities);
                
                for(var i =0; i < keys.length; i++){
                    var params = entities[keys[i]];
                    
                    ctx.fillStyle = params.style;
                    ctx.fillRect( params.x, params.y, params.width, params.height);
                }
            };
            
            // Utility function to generate random RBG
            function getRandomRGB(){
                var r = Math.floor(Math.random()* 256);
                var g = Math.floor(Math.random()* 256);
                var b = Math.floor(Math.random()* 256);

                return 'rgb(' + r +', ' + g + ',' + b +')';
            }
            
            // Connect the sockets and event listeners
            function init(){
                socket = io.connect();
                canvas = document.querySelector('canvas');
                ctx = canvas.getContext('2d');
                
                socket.on('connect', function() {
                    socket.emit('objectUpdate', {
                        user: user,
                        time: new Date().getTime(), 
                        x: (Math.random() * 500), y: (Math.random() * 500), 
                        width: (Math.random() * 60) + 10, height: (Math.random() * 50) + 15,
                        style: getRandomRGB()
                    });
                });
                
                socket.on('update', function(data){
                    
                    if(!entities[data.user]){
                        entities[data.user] = data;
                    }
                    else if( data.time > entities[data.user].time ){
                        entities[data.user] = data;
                    }
                    
                    draw();
                });
                
                // Keyboard Input
                
                document.addEventListener('keydown', function(e){
                    console.log(e.keyCode);
                    
                    var modified = false;
                    var entity = JSON.parse(JSON.stringify(entities[user]));
                    
                    if(e.keyCode == '68'){
                        entity.x += 4;
                        modified = true;
                    }
                    
                    if(e.keyCode == '65'){
                        entity.x -= 4;
                        modified = true;
                    }
                    
                    if(e.keyCode == '87'){
                        entity.y -= 4;
                        modified = true;
                    }
                    
                    if(e.keyCode == '83'){
                        entity.y += 4;
                        modified = true;
                    }
                    
                    if( modified ){
                        entity.time = new Date().getTime();
                        socket.emit('objectUpdate', entity);
                    }
                });
            };
            
            window.onload = init;
            
        </script>
    </head>

    <body>
        <canvas id="canvas" height="600" width="600">Please upgrade your browser.</canvas>
    </body>
</html>
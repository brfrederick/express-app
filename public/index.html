<!DOCTYPE html>
<html>
    <head>
        <title>Are your eyes bleeding yet?</title>
        
        <style>
          
            body {
              background-image: linear-gradient(135deg, rgba(0, 0, 0, 0) 84px, #d95b43 84px, #d95b43 100px, #ecd078 100px, #ecd078 106px, #c02942 106px, #c02942 120px, #ecd078 121px, #ecd078 127px, #542437 127px, #542437 142px, #ecd078 142px, #ecd078 148px, #53777a 148px, #53777a 163px, #ecd078 163px, #ecd078 168px, #d95b43 169px), linear-gradient(135deg, #d95b43 15px, #d95b43, #ecd078 15px, #ecd078 21px, #c02942 21px, #c02942 36px, #ecd078 36px, #ecd078 42px, #542437 42px, #542437 57.5px, #ecd078 57px, #ecd078 63px, #53777a 63px, #53777a 78px, #ecd078 78px, #ecd078 84px, rgba(0, 0, 0, 0) 84px, rgba(0, 0, 0, 0) 99px);
              background-size: 120px 120px;


            }
            
            h1{
                color:white;
                font-size: 3vmin;
                text-align: center;
                font-family: 'Permanent Marker', cursive;
                text-shadow: -2px 0 black, 0 2px black, 2px 0 black, 0 -2px black;
                padding-top: 3em;
                z-index: 500;
            }
            
            canvas{
                z-index: -10;
                position:absolute;
                top: 0px;
                left: 0px;
                
                height: 100vh;
                width: 100vw;
            }

        </style>
        
        <script src="/socket.io/socket.io.js"></script>
        <script>
            // Socket.io vars
            var socket;
            
            // Canvas vars
            var canvas;
            var ctx;            
            var canvasBuffer;
            var ctxBuffer;
            
            // App vars
            var user = 'user' + (Math.floor((Math.random() * 1000)) + 1);
            var entities = {};
            
            // Draws entities to screen
            function draw(){
                // Clear the canvas
                ctx.clearRect(0,0,canvas.width, canvas.height);
                
                var keys = Object.keys(entities);
                
                for(var i =0; i < keys.length; i++){
                    var entity = entities[keys[i]];
                    
                    ctx.save();
                    ctx.globalCompositeOperation = "source-over";
                    ctx.drawImage(entity.img, entity.x, entity.y, entity.width, entity.height);                    
                    ctx.restore;
                    
                    }
            };
            
            // Utility function to generate random RBG
            function getRandomRGB(){
                var r = Math.floor(Math.random()* 256);
                var g = Math.floor(Math.random()* 256);
                var b = Math.floor(Math.random()* 256);

                return 'rgb(' + r +', ' + g + ',' + b +')';
            }
            
            // Connect the sockets and event listeners
            function init(){
                // Setup canvas
                canvas = document.querySelector('canvas');
                ctx = canvas.getContext('2d');
                
                canvasBuffer = document.createElement('canvas');
                canvasBuffer.height = canvas.height;
                canvasBuffer.width = canvas.width;
                ctxBuffer = canvasBuffer.getContext('2d');
                
                
                // Setup socket io
                socket = io.connect();
                
                socket.on('connect', function() {
                    var entity = {
                        user: user,
                        time: new Date().getTime(), 
                        x: (Math.random() * (canvas.width * .7)), y: (Math.random() * (canvas.height * .7)), 
                        width: (Math.random() * 50) + 20, height: (Math.random() * 50) + 20,
                        style: getRandomRGB(),
                    };
                    
                    ctxBuffer.fillStyle = entity.style;
                    ctxBuffer.fillRect(entity.x, entity.y, entity.width, entity.height);
                    entity.imgData = canvasBuffer.toDataURL();
                    
                    socket.emit('objectUpdate', entity);
                });
                
                socket.on('update', function(data){
                    
                    if(!entities[data.user] || data.time > entities[data.user].time){
                        entities[data.user] = data;
                        
                        var img = new Image()
                        img.onload = function(){
                            console.log('image loaded');
                                                        
                            entities[data.user] = data;
                            entities[data.user].img = img;
                            draw();
                        };

                        img.src = data.imgData;
                    }              
                    
                });
                
                // Keyboard Input
                
                document.addEventListener('keydown', function(e){
                    console.log(e.keyCode);
                    
                    var modified = false;
                    var entity = JSON.parse(JSON.stringify(entities[user]));
                    
                    if(e.keyCode == '68'){
                        entity.x += 4;
                        modified = true;
                    }
                    
                    if(e.keyCode == '65'){
                        entity.x -= 4;
                        modified = true;
                    }
                    
                    if(e.keyCode == '87'){
                        entity.y -= 4;
                        modified = true;
                    }
                    
                    if(e.keyCode == '83'){
                        entity.y += 4;
                        modified = true;
                    }
                    
                    if( modified ){
                        entity.time = new Date().getTime();
                        socket.emit('objectUpdate', entity);
                    }
                });
            };
            
            window.onload = init;
            
        </script>
    </head>

    <body>
        <h1>WASD keys to move</h1>
        <canvas id="canvas"> Please upgrade your browser.</canvas>
    </body>
</html>